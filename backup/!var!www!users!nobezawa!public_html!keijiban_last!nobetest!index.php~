


<?php
ini_set( 'display_errors', 1 );

//文字コードの読み込み
require_once("function.php");
session_start();

$error = "";
/*
//œò¿¨œò¿éœò¿üœò¿Áœò¿§œò¿Ãœò¿¯å‡¦ç†
if (!empty($_POST)) {
	if ($_POST['name'] == '') {
		$error['name'] = 'blank';
	}
	
	if ($_POST['content'] == '') {
		$error['content'] = 'blank';
	
	
	}
}
*/



if(isset($_POST['name']) && isset($_POST['content'])){

	$name = htmlspecialchars($_POST['name'],ENT_QUOTES);
	$content = htmlspecialchars($_POST['content'],ENT_QUOTES);
	if ($name == "" && $content == "") {
		//åå‰œò¾âå†…å®¹œò¾âœò¾Êœò¾¤æ™‚
		//ç•ªå·œò¾Îå–å¾—
		$num = file("num.txt");
		$newNum = $num[0]+1;
		$numWrite = fopen("num.txt", "w");
		$write = fwrite($numWrite, $newNum);
		fclose($numWrite);
		
		$name = "ç„¡å";
		$content = "æœ¬æ–‡œò¾Ïœò¾¢œò¾êœò¾Þœò¾»œò¾ó";
		$data = array();
		//csvœò¿Õœò¿¡œò¿¤œò¿ëœò¾òœò¿ªœò¿üœò¿×œò¿ó
		$data = array($newNum,$name,$content);
		$fp = fopen('text.csv', "a");
		fputcsv($fp, $data);
		fclose($fp);
		
	} else {
		//ç•ªå·œò¾Îå–å¾—
		$num = file("num.txt");
		$newNum = $num[0]+1;
		$numWrite = fopen("num.txt", "w");
		$write = fwrite($numWrite, $newNum);
		fclose($numWrite);
		
		//œò¿Àœò¿Öœò¿ëœò¿¯œò¿ªœò¿üœò¿Æœò¿üœò¿·œò¿çœò¿óœò¾Îæ›¸œò¾­æ›œò¾¨
		$checkName = str_replace("\"", "\"\"", $name);
		$checkContent = str_replace("\"", "\"\"", $content); 
		if ($checkName == "") {//åå‰œò¾Êœò¾·
			$checkName = "ç„¡å";
			$data = array($newNum,$checkName,$checkContent);
			$fp = fopen('text.csv', "a");
			fputcsv($fp, $data);
			fclose($fp);
		}else if($checkContent == ""){//æœ¬æ–‡œò¾Êœò¾·
			$checkContent = "æœ¬æ–‡œò¾Ïœò¾¢œò¾êœò¾Þœò¾»œò¾ó";
			$data = array($newNum,$checkName,$checkContent);
			$fp = fopen('text.csv', "a");
			fputcsv($fp, $data);
			fclose($fp);
			
		}else{
			//csvœò¿Õœò¿¡œò¿¤œò¿ëœò¾òœò¿ªœò¿üœò¿×œò¿ó
			$data = array($newNum,$checkName,$checkContent);
			$fp = fopen('text.csv', "a");
			fputcsv($fp, $data);
			fclose($fp);
		}

	}

	//$_POSTœò¾ÎåˆæœŸåŒ–
	$_POST['name'] = "";
	$_POST['content'] = "";

	$name = "";
	$content = "";
	/*	
	$data = array();
	
	
	//ç•ªå·œò¾Îå–å¾—
	$num = file("num.txt");
	$newNum = $num[0]+1;
	$numWrite = fopen("num.txt", "w");
	$write = fwrite($numWrite, $newNum);
	fclose($numWrite);
	
	//œò¿Àœò¿Öœò¿ëœò¿¯œò¿ªœò¿üœò¿Æœò¿üœò¿·œò¿çœò¿óœò¾Îæ›¸œò¾­æ›œò¾¨
	$checkName = str_replace("\"", "\"\"", $name);
	$checkContent = str_replace("\"", "\"\"", $content); 
	
	*/
	
	//œò¿êœò¿Àœò¿¤œò¿ìœò¿¯œò¿Èå‡¦ç†œóòèæ›¸œò¾­è¾¼œò¾ßœò¾Èè¡¨ç¤ºå‡¦ç†œò¾Îåˆ†é›¢œóòé
	header('Location: index.php');
	exit();
}




//œò¿Çœò¿üœò¿¿œò¾òé…åˆ—œò¾Ëæ ¼ç´œò¾¹œò¾ë






//å‰Šé™¤å‡¦ç†
if (!empty($_POST['delete'])) {
	$delete = $_POST['delete'];
	$fp = fopen('text.csv', "r+");
		while($check_delete= fgetcsv($fp)){
		//var_dump($check_delete);
			list($number,$name,$content)=$check_delete;
			if ($number == $delete) {
				$newdata[] = "$number,wrong,wrong\n";
			}else{
				$newdata[] = "$number,$name,$content\n";
			}
		}
	ftruncate($fp, 0);
	rewind($fp);
		//var_dump($newdata);
		if (!empty($newdata)) {
			foreach ($newdata as $data3) {
				fwrite($fp, $data3);
			}
		}
	fclose($fp);
	
}

//è¿”ä¿¡æ©Ÿèƒ½
if (isset($_REQUEST['res'])) {
	$res = $_REQUEST['res'];
	$fp = fopen('text.csv', "r");
	while ($check_res= fgetcsv($fp)) {
		list($number,$name,$content)=$check_res;
		if ($number == $res) {
			$res_content = '@'.$name.''.$content."\n";
		}
	}


}
//ç·¨é›†æ©Ÿèƒ½

if (isset($_POST['e_id']) && isset($_POST['e_name']) && isset($_POST['e_content'])) {
	$edit_id = $_POST['e_id'];
	//var_dump($edit_id);
	$edit_name = $_POST['e_name'];
	$edit_content = $_POST['e_content'];
	$fp = fopen('text.csv', "r+");
		while($check_edit= fgetcsv($fp)){
		//var_dump($check_delete);
			list($number,$name,$content)=$check_edit;
			if ($number == $edit_id) {
				$newdata[] = "$edit_id,$edit_name,$edit_content\n";
			}else{
				$newdata[] = "$number,$name,$content\n";
			}
		}
	ftruncate($fp, 0);
	rewind($fp);
		if (!empty($newdata)) {
			foreach ($newdata as $data3) {
				fwrite($fp, $data3);
			}
		}
	fclose($fp);
	
}

//åˆæœŸåŒ–
if (!empty($_POST["zero"])) {
	//œò¿íœò¿°œò¾ÎåˆæœŸåŒ–
	$zero=fopen("num.txt", "w");
	fwrite($zero, "0");
	fclose($zero);
	
	//CSVœò¿Õœò¿¡œò¿¤œò¿ëœò¾ÎåˆæœŸåŒ–
	$text_zero=fopen("text.csv", "w");
	ftruncate($text_zero, 0);
	fclose($text_zero);
}



?>



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<head>
	<title>æŽ²ç¤ºæ¿</title>
<style>
	#main{
		width:600px;
		margin:0 auto;
	}
	h3{
		text-align: center;
	}
	table{
		border:2px solid #09F;
		border-collapse: collapse;
		width: 600px;
	}
	th{
		border:1px solid #09F;
		padding:10px;
		width: 300px
		
	}
	td{
		padding:10px;
		border:1px solid #09F;
	}
	
</style>


</head>
<body>


<div id="main">
<h3>æŽ²ç¤ºæ¿</h3>
<form action="index.php" method="post">
<table>
<tr>
<th>åå‰</th>
<td><input type="text" style="width:400px;" name="name" id="name" /></td>
</tr>
<tr>
<th>œò¿áœò¿Ãœò¿»œò¿üœò¿¸</th>
<td>
<textarea style="width:400px;height: 100px;" name="content" id="content" value="<?php if(!empty($res_content)){ echo htmlspecialchars($res_content, ENT_QUOTES);} ?>">
<?php if(!empty($res_content)){ echo htmlspecialchars($res_content, ENT_QUOTES);} ?></textarea>
</td>
</tr>
<tr>
<th colspan="2">
<input type="submit" name="submit" id="submit" value="æŠ•ç¨¿" />
</form>


<form action="index.php" method="post">
<input type="submit" value="œò¿êœò¿»œò¿Ãœò¿È" />
<input type="hidden" name="zero" value="zero" />
</form>
</th>
</tr>
</table>
<?php


//csvœò¿Õœò¿¡œò¿¤œò¿ëœò¾òœò¿ªœò¿üœò¿×œò¿ó
$fp = fopen("text.csv", "r");
$data2 = 0;
//fgetcsvé–¢æ•°œò¾¬falseœò¾òè¿”å´œò¾¹œò¾ëœò¾Þœò¾Çå®Ÿè¡Œ
while ($data2 = fgetcsv($fp, 1000)) {
	if ($data2[1] != "wrong") {
		
	
	echo "<div>";
	for ($i=0; $i<count($data2) ; $i++) { 
		echo "<p>" . $data2[$i] . "</p>". "\n";

	}
	echo '<form action="index.php" method="post">';
	echo '<input type="submit" value="å‰Šé™¤" />';
	echo "<input type=\"hidden\" name=\"delete\" value=$data2[0] />";
	echo "<a href=\"index.php?res=$data2[0]\">[RE]</a>";
	echo '</form>';
	echo '<form action="write.php" method="post">';
	echo '<input type="submit" value="ç·¨é›†" />';
	echo "<input type=\"hidden\" value=\"$data2[0]\" name=\"w_id\" />";
	echo "<input type=\"hidden\" value=\"$data2[1]\" name=\"w_name\" />";
	echo "<input type=\"hidden\" value=\"$data2[2]\" name=\"w_content\" />";
	echo '</form>';
	echo "<hr>";
	echo "</div>";
	}
}

fclose($fp);



?>



</div>
</body>

</html>